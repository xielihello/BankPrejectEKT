@{
    ViewBag.Title = "典阅智慧财经综合技能竞赛平台";
    ViewData["nvc"] = "个人资料";
    Layout = "~/Views/Shared/_StudentLayout.cshtml";
}
<link href="~/CSS/bootstrap.min.css" rel="stylesheet">
<link href="~/CSS/student.css" rel="stylesheet">
<style type="text/css">
    .inputsty input {
        border: 1px solid #703b07;
        color: #703b07;
    }

    .inputsty select {
        appearance: none;
        /* 去掉默认样式*/
        -moz-appearance: none;
        -webkit-appearance: none;
        border: 1px solid #703b07;
        color: #703b07;
        width: 150px;
        font-weight: 600;
        outline: none;
        background: url(../img/student/inputright.png) right no-repeat;
    }

    .action {
        width: 400px;
        height: 30px;
        margin: 10px 0;
    }
    .imageBox {
        position: relative;
        height: 400px;
        width: 400px;
        border: 1px solid #aaa;
        background: #fff;
        overflow: hidden;
        background-repeat: no-repeat;
        cursor: move;
        box-shadow: 4px 4px 12px #B0B0B0;
    }

        .imageBox .thumbBox {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            margin-top: -100px;
            margin-left: -100px;
            box-sizing: border-box;
            border: 1px solid rgb(102, 102, 102);
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
            background: none repeat scroll 0% 0% transparent;
        }

        .imageBox .spinner {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            text-align: center;
            line-height: 400px;
            background: rgba(0, 0, 0, 0.7);
        }

    .Btnsty_peyton {
        float: right;
        width: 66px;
        display: inline-block;
        margin-bottom: 10px;
        height: 57px;
        line-height: 57px;
        font-size: 20px;
        color: #FFFFFF;
        margin: 0px 2px;
        background-color: #f38e81;
        border-radius: 3px;
        text-decoration: none;
        cursor: pointer;
        box-shadow: 0px 0px 5px #B0B0B0;
        border: 0px #fff solid;
    }
    /*选择文件上传*/

    .new-contentarea {
        width: 165px;
        overflow: hidden;
        margin: 0 auto;
        position: relative;
        float: left;
    }

        .new-contentarea label {
            width: 100%;
            height: 100%;
            display: block;
        }

        .new-contentarea input[type=file] {
            width: 188px;
            height: 60px;
            background: #333;
            margin: 0 auto;
            position: absolute;
            right: 50%;
            margin-right: -94px;
            top: 0;
            right /*\**/
            : 0px\9;
            margin-right /*\**/
            : 0px\9;
            width /*\**/
            : 10px\9;
            opacity: 0;
            filter: alpha(opacity=0);
            z-index: 2;
        }

    a.upload-img {
        width: 165px;
        display: inline-block;
        margin-bottom: 10px;
        height: 57px;
        line-height: 57px;
        font-size: 20px;
        color: #FFFFFF;
        background-color: #f38e81;
        border-radius: 3px;
        text-decoration: none;
        cursor: pointer;
        border: 0px #fff solid;
        box-shadow: 0px 0px 5px #B0B0B0;
    }

        a.upload-img:hover {
            background-color: #ec7e70;
        }

    .tc {
        text-align: center;
    }
</style>
@{
    var m = Session["UserInfo"] as VocationalProject_Models.tb_UserInfo;
        
}
<div class="stu_map">
    <!--头部导航开始-->

    <!--头部导航结束-->
    <div class="stu_con" style="margin-top: 5vmin;">
        <!--切换标签开始-->
        <div class="person_map">
            <div class="person_con">
                <div class="dc_title">
                    个人资料
                </div>
                <div class="row">
                    <form class="form-horizontal" name="signupForm" id="signupForm">

                        <div class="col-sm-12 " style="margin-top: 30px; margin-bottom: 30px;">

                            <div class="col-sm-5" style="border-right: 2px dashed #cae6ef;">
                                <div class="form-group" style="margin-top: 10px;">
                                    <label class="col-sm-12 ">用户头像：</label>
                                    <div class="col-sm-12 text-center">
                                        <div class="cropped">
                                            <img id="use_img" src="@(!string.IsNullOrEmpty(m.UserPic) ? m.UserPic : "/img/profile_s.jpg")" style="width: 180px; margin-top: 4px; border-radius: 180px; box-shadow: 0px 0px 12px #7E7E7E;" class="img-circle" alt="User Image">
                                        </div>
                                        <input type="hidden" id="ImgUrl" name="ImaUrl" value="" />
                                        <a style="margin-top: 20px;" href="javascript:void(0);" onclick="change_use();" class="btn btn-warning form-group_but ">更改头像</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-7" style="margin-top: 10px;">
                                <div class="form-group" style="margin-top: 30px;">
                                    <label class="col-sm-3 control-label">姓名：</label>

                                    <div class="col-sm-5 inputsty">
                                        <input type="text" maxlength="20" id="Uname" class="form-control" placeholder="比如：张三">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 30px;">
                                    <label class="col-sm-3 control-label">性别：</label>
                                    <div class="col-sm-3">
                                        <input type="radio" class="i-checks" id="sex1" value="男" name="AddSex"><span class="m-l-sm m-r-sm">男</span>
                                        <input type="radio" class="i-checks" id="sex2" value="女" name="AddSex"><span class="m-l-sm">女</span>
                                    </div>

                                </div>
                                @*<div class="form-horizontal  m-t-sm">
                                    <label for="firstname" class="col-sm-4 control-label"><span style="color: red;">*</span>教师性别：</label>
                                    <div class="col-sm-8">
                                        <input type="radio" class="i-checks" id="" value="男" name="AddSex"><span class="m-l-sm m-r-sm">男</span>
                                        <input type="radio" class="i-checks" id="" value="女" name="AddSex"><span class="m-l-sm">女</span>
                                    </div>
                                </div>*@
                                <div class="form-group" style="margin-top: 30px;">
                                    <label class="col-sm-3 control-label">微信：</label>

                                    <div class="col-sm-5 inputsty">
                                        <input type="text" maxlength="20" id="WX" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 30px;">
                                    <label class="col-sm-3 control-label">QQ：</label>

                                    <div class="col-sm-5 inputsty">
                                        <input type="text" maxlength="20" id="QQ" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 30px;">
                                    <label class="col-sm-3 control-label">电话号码：</label>

                                    <div class="col-sm-5 inputsty">
                                        <input type="text" maxlength="20" id="phone" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 30px;">
                                    <label class="col-sm-3 control-label">密码：</label>
                                    <div class="col-sm-5 inputsty">
                                        <input type="password" id="Upwd" class="form-control" placeholder="" onkeyup="value=value.replace(/[^\w\.\/]/ig,'')">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 30px;">
                                    <label class="col-sm-3 control-label">重复密码：</label>
                                    <div class="col-sm-5 inputsty">
                                        <input type="password" id="Upwd1" class="form-control" placeholder="" onkeyup="value=value.replace(/[^\w\.\/]/ig,'')">
                                    </div>
                                </div>

                            </div>
                        </div>
                    </form>
                </div>
                <div class=" text-center" style="border-top: 2px dashed #cae6ef; clear: both; padding-top: 15px;">
                    <a class="btn btn-info form-group_but" onclick="update();">保存修改</a>
                </div>
            </div>
            <!--切换标签结束-->
        </div>

    </div>
</div>
<div id="change_use" style="display: none;">
    <div class="box-body ">
        <div class="col-sm-12" style="margin-top: 10px;">
            <div style="margin: auto; width: 400px;">

                <div class="imageBox">
                    <div class="thumbBox"></div>
                    <div class="spinner" style="display: none">Loading...</div>
                </div>
                <div class="action">
                    <!-- <input type="file" id="file" style=" width: 200px">-->
                    <div class="new-contentarea tc">
                        <a href="javascript:void(0)" class="upload-img">
                            <label for="upload-file">选择图像</label>
                        </a>
                        <input type="file" class="" name="upload-file" id="upload-file" />
                    </div>
                    <input type="button" id="btnCrop" class="Btnsty_peyton" value="保存">
                    <input type="button" id="btnZoomIn" class="Btnsty_peyton" value="+">
                    <input type="button" id="btnZoomOut" class="Btnsty_peyton" value="-">
                </div>

            </div>

        </div>
    </div>
</div>
<!--上传头像区域结束-->

<script src="~/Scripts/jquery-3.2.0.js"></script>
<script src="~/Scripts/bootstrap.min.js"></script>
<!--弹窗js-->
@*	<script src="~/Scripts/plugins/layer/layer.js"></script>*@
<!--头像上传插件-->
<script src="~/Scripts/cropbox.js"></script>

<script type="text/javascript">
    //radio选中样式
    var Upwd;  //用户密码
    var Uno = "";
    var diyImg = 0;
    //学生修改信息
    function update() {
        //  debugger;
        //    var img=document.getElementById("use_img").src;
        debugger;
        var name = $("#Uname").val();
        var UID = Uno;
        var img = document.getElementById("use_img").src;
        var sex = $("input[type='radio']:checked").val();
        var WX = $("#WX").val();
        var QQ = $("#QQ").val();
        var phone = $("#phone").val();
        if (diyImg == 1) {

            $("#ImgUrl").val(img);
            //sumitImageFile(img);
            //return;
        }
       // alert(sex);
        if ($("#Upwd").val() != Upwd) {
            if ($("#Upwd").val() == $("#Upwd1").val()) {
                var Pwd = $("#Upwd").val();
                $.ajax({
                    url: '/Ashx/Studentinfo.ashx?action=updateinfo&UId=' + UID + '&name=' + name + "&diyImg=" + diyImg + "&Pwd=" + Pwd + "&sex=" + sex + "&WX=" + WX + "&QQ=" + QQ + "&phone=" + phone,
                    type: 'POST',
                    dataType: 'text',
                    async: false,
                    data: { "ImgUrl": $("#ImgUrl").val() },
                    success: function (data) {
                        debugger;
                        var url = img;
                        window.parent.imgUrlStu(url, name);

                        $.ajax({
                            url: '/Student/updateinfo',
                            type: 'POST',
                            dataType: 'text',
                            async: false,
                            data: { data: url, data1: name },
                            success: function (data) {
                                //var data = eval('(' + data + ')');
                                //if (data.length != 0) {
                                if ($("#Upwd").val().length > 0 && $("#Upwd").val() != Upwd) {
                                    layer.alert('密码修改成功,请重新登录！', {
                                        closeBtn: 0
                                    }, function () {
                                        $("form[name='myUserExit']").submit();
                                    });
                                }
                                else {
                                    layer.alert('修改成功！');
                                }
                            }

                        });
                    }
                });
            }
            else {
                layer.alert("新密码与重复密码不一致!");
                return;
            }
        }
        else {
            layer.alert("新密码与重复密码不一致!");
            return;
        }
    }

    function clickaddimg() {
        $('#File_Send').click();
    }
    function setImagePreview() {
        //  alert("a");
        debugger;
        $("#addimg").html('<img src="/img/xguse.png" onclick="clickaddimg()" style="width: 180px;height:180px; margin-top: 4px; border-radius: 180px; box-shadow: 0px 0px 12px #7E7E7E;" id="preview" />');
        //选择图片后直接显示
        //  alert($("#addimg").html())
        var docObj = document.getElementById("File_Send");
        var imgObjPreview = document.getElementById("preview");
        if (docObj.files && docObj.files[0]) {
            var f = docObj.files;
            var imgtype = f[0].name;//获取文件名
            //判断只能设置图片
            var exp = /.jpg$|.gif$|.png$|.bmp$/;
            if (exp.exec(imgtype) == null) {
                layer.alert('图片格式不正确！', {
                    skin: 'layui-layer-red', closeBtn: 0
                });
                return false;
            }
            imgObjPreview.src = window.URL.createObjectURL(docObj.files[0]);
            diyImg = 1;
        }
        return true;
    }
    //上传头像弹窗区域
    function change_use() {
        layer.open({
            title: '上传头像',
            area: ['500px', '550px'],
            //	offset: ['5vmin'],//定义弹窗位置 距离顶部5vmin
            type: 1,
            skin: 'layui-layer-lan', //样式类名
            closeBtn: 1, //显示关闭按钮
            anim: 2,
            shadeClose: true, //开启遮罩关闭
            content: $("#change_use")
        });
    }

    //头像上传插件开始

    $(function () {
        //$('.i-checks').iCheck({
        //    checkboxClass: 'icheckbox_square-green',
        //    radioClass: 'iradio_square-green',
        //});
        debugger;
        var options = {
            thumbBox: '.thumbBox',
            spinner: '.spinner',
            imgSrc: '/img/profile_s.jpg'
        }
        var cropper = $('.imageBox').cropbox(options);
        $('#upload-file').on('change', function () {
            var reader = new FileReader();
            reader.onload = function (e) {
                options.imgSrc = e.target.result;
                cropper = $('.imageBox').cropbox(options);
            }
            reader.readAsDataURL(this.files[0]);
            //this.files = [];
        })
        $('#btnCrop').on('click', function () {
            debugger;
            var img = cropper.getDataURL();
            if (img != 0) { //判断是否选择图片
                $("#use_img").attr("src", img);
                diyImg = 1;
                layer.closeAll();
            } else {
                alert("没有选择图片");
            }
        })
        $('#btnZoomIn').on('click', function () {
            cropper.zoomIn();
        })
        $('#btnZoomOut').on('click', function () {
            cropper.zoomOut();
        })
        $.ajax({
            //  url: '/Ashx/Admininfo.ashx?action=loadinfo',
            url: '/Student/loadinfo',
            type: 'POST',
            dataType: 'text',
            async: false,
            success: function (data) {
                var data = eval('(' + data + ')');
                if (data.length != 0) {
                    debugger;
                //    $("#use_img").attr("src", data[0]["UserPic"]);
                    Uno = data[0]["UserNo"];
                    Upwd = data[0]["UserPwd"];
                    $("#Uname").val(data[0]["UserName"]);
                    $("#WX").val(data[0]["UserWX"]);
                    $("#QQ").val(data[0]["UserQQ"]);
                    $("#phone").val(data[0]["UserPhone"]);
                    if (data[0]["UserSex"] == "男") {
                        $("#sex1").attr("checked", "checked");
                    }
                    else
                    {
                        $("#sex2").attr("checked", "checked");
                    }
                }
            }
        });
    })
</script>
